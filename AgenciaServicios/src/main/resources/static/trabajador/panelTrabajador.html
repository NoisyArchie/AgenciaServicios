<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title>Panel Trabajador - Siscare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-[#0D0D0D] text-white min-h-screen flex">
    <!-- SIDEBAR -->
    <aside class="w-64 bg-black/80 border-r border-orange-600/20 flex flex-col justify-between py-6 px-4">
        <div>
            <h2 class="text-3xl font-bold text-orange-500 border-b border-gray-700 pb-2 mb-6 text-center">
                Siscare
            </h2>

            <nav class="flex flex-col gap-1">
                <a href="/trabajador/panelTrabajador.html" class="flex items-center gap-3 p-3 rounded bg-orange-500/20 transition">
                    <i class="bx bx-home text-xl"></i> Panel
                </a>

                <a href="/trabajador/servicios.html" class="flex items-center gap-3 p-3 rounded hover:bg-orange-500/20 transition">
                    <i class="bx bx-wrench text-xl"></i> Servicios
                </a>

                <a href="/trabajador/clientes.html" class="flex items-center gap-3 p-3 rounded hover:bg-orange-500/20 transition">
                    <i class="bx bx-user text-xl"></i> Clientes
                </a>
            </nav>
        </div>

        <div class="border-t border-gray-700 pt-4">
            <a href="#" class="flex items-center gap-3 p-3 hover:bg-red-500/30 rounded transition text-red-400">
                <i class="bx bx-log-out text-xl"></i> Cerrar Sesi√≥n
            </a>
        </div>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="flex-1 flex flex-col">
        <!-- NAVBAR SUPERIOR -->
        <header class="flex justify-between items-center px-8 py-4 border-b border-gray-800 bg-[#111]/80 backdrop-blur-sm">
            <div>
                <h1 class="text-2xl font-bold">Panel</h1>
                <p class="text-gray-400 text-sm">Resumen general para atenci√≥n al cliente</p>
            </div>

            <!-- Icono de usuario -->
            <div class="flex items-center gap-3">
                <span class="text-gray-300 text-sm">Trabajador</span>
                <button class="bg-orange-600 hover:bg-orange-500 p-2 rounded-full transition">
                    <i class="bx bx-user text-white text-xl"></i>
                </button>
            </div>
        </header>

        <!-- CONTENIDO -->
        <section class="p-8 flex-1 overflow-y-auto">
            <!-- Cards de Informaci√≥n R√°pida -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Servicios del D√≠a -->
                <div class="bg-[#1A1A1A] p-6 rounded-xl border border-gray-700">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-400 text-sm">Servicios Hoy</p>
                            <p class="text-3xl font-bold">-</p>
                            <p class="text-gray-400 text-sm mt-1">Cargando...</p>
                        </div>
                        <div class="bg-blue-500/20 p-4 rounded-full">
                            <i class="bx bx-calendar text-blue-400 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Servicios Activos -->
                <div class="bg-[#1A1A1A] p-6 rounded-xl border border-gray-700">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-400 text-sm">En Taller</p>
                            <p class="text-3xl font-bold text-yellow-400">-</p>
                            <p class="text-gray-400 text-sm mt-1">Cargando...</p>
                        </div>
                        <div class="bg-yellow-500/20 p-4 rounded-full">
                            <i class="bx bx-wrench text-yellow-400 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Clientes Nuevos -->
                <div class="bg-[#1A1A1A] p-6 rounded-xl border border-gray-700">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-400 text-sm">Clientes Mes</p>
                            <p class="text-3xl font-bold">-</p>
                            <p class="text-gray-400 text-sm mt-1">Cargando...</p>
                        </div>
                        <div class="bg-green-500/20 p-4 rounded-full">
                            <i class="bx bx-user-plus text-green-400 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Veh√≠culos Registrados -->
                <div class="bg-[#1A1A1A] p-6 rounded-xl border border-gray-700">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-400 text-sm">Veh√≠culos Mes</p>
                            <p class="text-3xl font-bold">-</p>
                            <p class="text-gray-400 text-sm mt-1">Cargando...</p>
                        </div>
                        <div class="bg-purple-500/20 p-4 rounded-full">
                            <i class="bx bx-car text-purple-400 text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°ficas Simples -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Servicios por Estatus -->
                <div class="bg-[#1A1A1A] p-6 rounded-xl border border-gray-700">
                    <h2 class="text-xl font-bold text-orange-400 mb-6">Servicios por Estatus</h2>
                    <div class="h-64">
                        <canvas id="graficaEstatus"></canvas>
                    </div>
                </div>

                <!-- Servicios de Hoy -->
                <div class="bg-[#1A1A1A] p-6 rounded-xl border border-gray-700">
                    <h2 class="text-xl font-bold text-orange-400 mb-6">Servicios de Hoy</h2>
                    <div class="space-y-4">
                        <div class="text-center py-8 text-gray-400">
                            <i class="bx bx-loader-circle bx-spin text-2xl mb-2"></i>
                            <p>Cargando servicios...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Acciones R√°pidas -->
            <div class="bg-[#1A1A1A] p-6 rounded-xl border border-gray-700">
                <h2 class="text-xl font-bold text-orange-400 mb-6">Acciones R√°pidas</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <a href="/trabajador/altaClientes.html" 
                       class="flex items-center gap-3 p-4 bg-green-600/20 hover:bg-green-600/30 border border-green-500/30 rounded-lg transition">
                        <div class="bg-green-500/20 p-3 rounded-full">
                            <i class="bx bx-user-plus text-green-400 text-xl"></i>
                        </div>
                        <div>
                            <p class="font-medium">Registrar Cliente</p>
                            <p class="text-gray-400 text-sm">Nuevo cliente en el sistema</p>
                        </div>
                    </a>

                    <a href="/trabajador/crearServicio.html"
                       class="flex items-center gap-3 p-4 bg-orange-600/20 hover:bg-orange-600/30 border border-orange-500/30 rounded-lg transition">
                        <div class="bg-orange-500/20 p-3 rounded-full">
                            <i class="bx bx-plus text-orange-400 text-xl"></i>
                        </div>
                        <div>
                            <p class="font-medium">Crear Servicio</p>
                            <p class="text-gray-400 text-sm">Nuevo servicio de taller</p>
                        </div>
                    </a>

                    <a href="/trabajador/altaVehiculoCliente.html"
                       class="flex items-center gap-3 p-4 bg-blue-600/20 hover:bg-blue-600/30 border border-blue-500/30 rounded-lg transition">
                        <div class="bg-blue-500/20 p-3 rounded-full">
                            <i class="bx bx-car text-blue-400 text-xl"></i>
                        </div>
                        <div>
                            <p class="font-medium">Agregar Veh√≠culo</p>
                            <p class="text-gray-400 text-sm">Veh√≠culo a cliente existente</p>
                        </div>
                    </a>
                </div>
            </div>
        </section>
    </main>

    <style>
        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
        }
    </style>

    <script>
    // URLs de TODOS tus endpoints existentes
    const API_URLS = {
        servicios: '/api/servicios',
        clientes: '/api/clientes',
        vehiculos: '/api/vehiculos'
    };

    // Inicializar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        inicializarGrafica();
        cargarDashboardCompleto();
    });

    // Inicializar gr√°fica
    function inicializarGrafica() {
        const ctx = document.getElementById('graficaEstatus').getContext('2d');
        
        window.graficaEstatus = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Pendiente', 'En Proceso', 'Completado', 'Entregado'],
                datasets: [{
                    label: 'Cantidad',
                    data: [0, 0, 0, 0],
                    backgroundColor: [
                        '#3B82F6', // Azul - Pendiente
                        '#F59E0B', // Amarillo - En Proceso
                        '#10B981', // Verde - Completado
                        '#059669'  // Verde oscuro - Entregado
                    ],
                    borderWidth: 0,
                    borderRadius: 6,
                    barPercentage: 0.6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#1F2937',
                        titleColor: '#F9FAFB',
                        bodyColor: '#D1D5DB'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#374151'
                        },
                        ticks: {
                            color: '#9CA3AF',
                            stepSize: 1
                        }
                    },
                    x: {
                        grid: {
                            color: '#374151'
                        },
                        ticks: {
                            color: '#9CA3AF'
                        }
                    }
                }
            }
        });
    }

    // Cargar dashboard COMPLETO con todos los datos
    async function cargarDashboardCompleto() {
        try {
            console.log('üîÑ Cargando dashboard del trabajador...');
            
            // Cargar todos los datos en paralelo
            const [servicios, clientes, vehiculos] = await Promise.all([
                cargarDatos(API_URLS.servicios),
                cargarDatos(API_URLS.clientes),
                cargarDatos(API_URLS.vehiculos)
            ]);

            console.log('‚úÖ Datos cargados:', {
                servicios: servicios.length,
                clientes: clientes.length,
                vehiculos: vehiculos.length
            });

            // Procesar todos los datos espec√≠ficos para trabajador
            const datosProcesados = procesarDatosTrabajador(servicios, clientes, vehiculos);
            actualizarUITrabajador(datosProcesados);
            
        } catch (error) {
            console.error('‚ùå Error cargando dashboard:', error);
            mostrarError('Error al cargar los datos');
        }
    }

    // Funci√≥n gen√©rica para cargar datos
    async function cargarDatos(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Error ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error(`Error cargando ${url}:`, error);
            return [];
        }
    }

    // Procesar datos ESPEC√çFICOS para el panel del trabajador
    function procesarDatosTrabajador(servicios, clientes, vehiculos) {
        const hoy = new Date();
        const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
        const inicioHoy = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
        
        // Servicios de HOY (por fecha de ingreso)
        const serviciosHoy = servicios.filter(servicio => {
            if (!servicio.fechaIngreso) return false;
            const fechaIngreso = new Date(servicio.fechaIngreso);
            return fechaIngreso >= inicioHoy;
        });

        // Servicios en taller (En Proceso)
        const serviciosEnTaller = servicios.filter(s => s.estatus === 'EN_PROCESO');

        // Clientes registrados este mes (clientes con fecha de registro este mes)
        const clientesEsteMes = clientes.filter(cliente => {
            if (!cliente.fechaRegistro) return false;
            const fechaRegistro = new Date(cliente.fechaRegistro);
            return fechaRegistro >= inicioMes;
        });

        // Veh√≠culos registrados este mes (veh√≠culos con fecha de registro este mes)
        const vehiculosEsteMes = vehiculos.filter(vehiculo => {
            if (!vehiculo.fechaRegistro) return false;
            const fechaRegistro = new Date(vehiculo.fechaRegistro);
            return fechaRegistro >= inicioMes;
        });

        // Contar servicios por estatus
        const pendientes = servicios.filter(s => s.estatus === 'PENDIENTE').length;
        const enProceso = servicios.filter(s => s.estatus === 'EN_PROCESO').length;
        const completados = servicios.filter(s => s.estatus === 'COMPLETADO').length;
        const entregados = servicios.filter(s => s.estatus === 'ENTREGADO').length;

        // Servicios de hoy (√∫ltimos 5)
        const serviciosHoyLista = serviciosHoy
            .sort((a, b) => new Date(b.fechaIngreso) - new Date(a.fechaIngreso))
            .slice(0, 5);

        return {
            // Estad√≠sticas principales para trabajador
            serviciosHoy: serviciosHoy.length,
            enTaller: serviciosEnTaller.length,
            clientesMes: clientesEsteMes.length,
            vehiculosMes: vehiculosEsteMes.length,
            
            // Datos para gr√°fica
            serviciosEstatus: {
                PENDIENTE: pendientes,
                EN_PROCESO: enProceso,
                COMPLETADO: completados,
                ENTREGADO: entregados
            },
            
            // Lista de servicios de hoy
            serviciosHoyLista: serviciosHoyLista.map(servicio => ({
                folio: 'SER-' + String(servicio.folioServicio).padStart(6, '0'),
                vehiculo: servicio.vehiculo ? 
                    `${servicio.vehiculo.modelo?.marca?.nombreMarca || 'Marca'} ${servicio.vehiculo.modelo?.nombreModelo || 'Modelo'}` : 
                    'Sin veh√≠culo',
                cliente: servicio.vehiculo?.cliente?.nombreCompleto || 'Sin cliente',
                estatus: servicio.estatus ? servicio.estatus.toLowerCase() : 'pendiente',
                fecha: servicio.fechaIngreso
            }))
        };
    }

    // Actualizar la interfaz para TRABAJADOR
    function actualizarUITrabajador(datos) {
        const serviciosEstatus = datos.serviciosEstatus || {};
        
        console.log('üìä Actualizando UI del trabajador:', datos);
        
        // ACTUALIZAR LAS 4 CARDS PRINCIPALES DEL TRABAJADOR
        actualizarCardsTrabajador(datos);
        
        // Actualizar gr√°fica de estatus
        actualizarGraficaEstatus(serviciosEstatus);

        // Actualizar lista de servicios de hoy
        actualizarServiciosHoy(datos.serviciosHoyLista);
    }

    // Actualizar las 4 cards espec√≠ficas del trabajador - SIMPLIFICADO
    function actualizarCardsTrabajador(datos) {
        // M√©todo SIMPLE: buscar directamente por posici√≥n en el grid
        const grid = document.querySelector('.grid');
        
        if (grid) {
            const cards = grid.children;
            
            if (cards.length >= 4) {
                // Card 1: Servicios Hoy
                actualizarCard(cards[0], datos.serviciosHoy || '0', 
                    datos.serviciosHoy > 0 ? 'Servicios ingresados hoy' : 'Sin servicios hoy');
                
                // Card 2: En Taller
                actualizarCard(cards[1], datos.enTaller || '0', 
                    datos.enTaller > 0 ? 'En proceso de reparaci√≥n' : 'Sin servicios en taller');
                
                // Card 3: Clientes Mes
                actualizarCard(cards[2], datos.clientesMes || '0', 
                    datos.clientesMes > 0 ? 'Clientes registrados este mes' : 'Sin clientes nuevos');
                
                // Card 4: Veh√≠culos Mes
                actualizarCard(cards[3], datos.vehiculosMes || '0', 
                    datos.vehiculosMes > 0 ? 'Veh√≠culos registrados este mes' : 'Sin veh√≠culos nuevos');
            }
        } else {
            // M√©todo alternativo: buscar por texto espec√≠fico
            buscarYActualizarPorTexto('Servicios Hoy', datos.serviciosHoy || '0');
            buscarYActualizarPorTexto('En Taller', datos.enTaller || '0');
            buscarYActualizarPorTexto('Clientes Mes', datos.clientesMes || '0');
            buscarYActualizarPorTexto('Veh√≠culos Mes', datos.vehiculosMes || '0');
        }
    }

    // Funci√≥n auxiliar para actualizar una card individual
    function actualizarCard(card, valor, descripcion) {
        const numeroElement = card.querySelector('.text-3xl');
        const descripcionElement = card.querySelector('.text-gray-400.text-sm.mt-1');
        
        if (numeroElement) {
            numeroElement.textContent = valor;
            console.log(`‚úÖ Actualizada card: ${valor}`);
        }
        if (descripcionElement) {
            descripcionElement.textContent = descripcion;
        }
    }

    // M√©todo alternativo: buscar por texto y actualizar
    function buscarYActualizarPorTexto(textoBuscado, valor) {
        // Buscar elemento que contenga el texto
        const elementos = Array.from(document.querySelectorAll('*')).filter(el => 
            el.textContent && el.textContent.includes(textoBuscado)
        );
        
        if (elementos.length > 0) {
            // Tomar el primer elemento que coincida
            const elemento = elementos[0];
            const card = elemento.closest('div');
            
            if (card) {
                const numeroElement = card.querySelector('.text-3xl');
                if (numeroElement) {
                    numeroElement.textContent = valor;
                    console.log(`‚úÖ Actualizada ${textoBuscado}: ${valor}`);
                }
            }
        }
    }

    // Actualizar gr√°fica de estatus
    function actualizarGraficaEstatus(serviciosEstatus) {
        const grafica = Chart.getChart('graficaEstatus');
        if (grafica) {
            grafica.data.datasets[0].data = [
                serviciosEstatus.PENDIENTE || 0,
                serviciosEstatus.EN_PROCESO || 0,
                serviciosEstatus.COMPLETADO || 0,
                serviciosEstatus.ENTREGADO || 0
            ];
            grafica.update();
            console.log('‚úÖ Gr√°fica actualizada');
        }
    }

    // Actualizar lista de servicios de hoy
    function actualizarServiciosHoy(servicios) {
        const container = document.querySelector('.space-y-4');
        
        if (!container) {
            console.log('No se encontr√≥ el contenedor de servicios de hoy');
            return;
        }
        
        if (servicios && servicios.length > 0) {
            container.innerHTML = servicios.map(servicio => `
                <div class="flex justify-between items-center p-3 bg-black/30 rounded-lg border border-gray-700">
                    <div>
                        <p class="font-medium">${servicio.folio}</p>
                        <p class="text-gray-400 text-sm">${servicio.vehiculo} - ${servicio.cliente}</p>
                    </div>
                    <div class="text-right">
                        <span class="${obtenerClaseEstatus(servicio.estatus)} px-2 py-1 rounded-full text-xs">
                            ${obtenerTextoEstatus(servicio.estatus)}
                        </span>
                        <p class="text-gray-400 text-sm mt-1">${formatearFecha(servicio.fecha)}</p>
                    </div>
                </div>
            `).join('');
            console.log(`‚úÖ Lista de servicios actualizada: ${servicios.length} servicios`);
        } else {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-400">
                    <i class="bx bx-calendar-x text-2xl mb-2"></i>
                    <p>No hay servicios para hoy</p>
                    <p class="text-sm mt-1">Los servicios ingresados hoy aparecer√°n aqu√≠</p>
                </div>
            `;
            console.log('‚úÖ Lista de servicios: Sin servicios hoy');
        }
    }

    // Funciones auxiliares
    function obtenerClaseEstatus(estatus) {
        const clases = {
            'pendiente': 'bg-blue-500/20 text-blue-400',
            'en_proceso': 'bg-yellow-500/20 text-yellow-400',
            'completado': 'bg-green-500/20 text-green-400',
            'entregado': 'bg-green-500/20 text-green-400',
            'cancelado': 'bg-red-500/20 text-red-400'
        };
        return clases[estatus] || 'bg-gray-500/20 text-gray-400';
    }

    function obtenerTextoEstatus(estatus) {
        const textos = {
            'pendiente': 'Pendiente',
            'en_proceso': 'En Proceso',
            'completado': 'Completado',
            'entregado': 'Entregado',
            'cancelado': 'Cancelado'
        };
        return textos[estatus] || estatus;
    }

    function formatearFecha(fechaString) {
        if (!fechaString) return 'Fecha no disponible';
        try {
            const fecha = new Date(fechaString);
            return fecha.toLocaleDateString('es-MX', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (error) {
            return 'Fecha inv√°lida';
        }
    }

    function mostrarError(mensaje) {
        console.error('Error:', mensaje);
        // Mostrar notificaci√≥n de error
        const errorDiv = document.createElement('div');
        errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-lg z-50';
        errorDiv.innerHTML = `
            <div class="flex items-center gap-2">
                <i class="bx bx-error"></i>
                <span>${mensaje}</span>
            </div>
        `;
        document.body.appendChild(errorDiv);
        
        setTimeout(() => errorDiv.remove(), 5000);
    }

    // Recargar cada 2 minutos
    setInterval(() => {
        cargarDashboardCompleto();
    }, 120000);
</script>
        

</body>
</html>