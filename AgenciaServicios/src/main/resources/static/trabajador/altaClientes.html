<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Alta de Clientes - Siscare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
</head>

<body class="bg-[#0D0D0D] text-white min-h-screen flex">
<!-- SIDEBAR -->
<aside class="w-64 bg-black/80 border-r border-orange-600/20 flex flex-col justify-between py-6 px-4">
    <div>
        <h2 class="text-3xl font-bold text-orange-500 border-b border-gray-700 pb-2 mb-6 text-center">
            Siscare
        </h2>

        <nav class="flex flex-col gap-1">
            <a href="/trabajador/panelTrabajador.html" class="flex items-center gap-3 p-3 rounded hover:bg-orange-500/20 transition">
                <i class="bx bx-home text-xl"></i> Panel
            </a>

            <a href="/trabajador/servicios.html" class="flex items-center gap-3 p-3 rounded hover:bg-orange-500/20 transition">
                <i class="bx bx-wrench text-xl"></i> Servicios
            </a>

            <a href="/trabajador/clientes.html" class="flex items-center gap-3 p-3 rounded hover:bg-orange-500/20 transition">
                <i class="bx bx-user text-xl"></i> Clientes
            </a>
        </nav>
    </div>

    <div class="border-t border-gray-700 pt-4">
        <button onclick="cerrarSesion()" class="w-full flex items-center gap-3 p-3 hover:bg-red-500/30 rounded transition text-red-400">
            <i class="bx bx-log-out text-xl"></i> Cerrar Sesión
        </button>
    </div>
</aside>

<!-- CONTENIDO PRINCIPAL -->
<main class="flex-1 flex flex-col">
    <!-- NAVBAR SUPERIOR -->
    <header class="flex justify-between items-center px-8 py-4 border-b border-gray-800 bg-[#111]/80 backdrop-blur-sm">
        <!-- Icono de usuario -->
        <div class="flex items-center gap-3">
            <span id="usuarioNombre" class="text-gray-300 text-sm">Trabajador</span>
            <button class="bg-orange-600 hover:bg-orange-500 p-2 rounded-full transition">
                <i class="bx bx-user text-white text-xl"></i>
            </button>
        </div>
    </header>

    <!-- CONTENIDO -->
    <section class="p-8 flex-1 overflow-y-auto">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold">Registrar Nuevo Cliente</h1>
                    <p class="text-gray-400 text-sm">
                        Completa la información para registrar un nuevo cliente en el sistema
                    </p>
                </div>

                <a href="/trabajador/clientes.html"
                   class="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 transition px-4 py-2 rounded shadow">
                    <i class="bx bx-arrow-back"></i> Volver a Clientes
                </a>
            </div>

            <!-- Formulario de Alta -->
            <div class="bg-[#1A1A1A] p-6 rounded-xl border border-gray-700">
                <form id="formAltaCliente" class="space-y-8">
                    <!-- Sección 1: Información Personal -->
                    <div>
                        <h2 class="text-xl font-bold text-orange-400 mb-4 flex items-center gap-2">
                            <i class="bx bx-user-circle"></i>
                            Información Personal
                        </h2>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    Nombre Completo *
                                </label>
                                <input type="text" id="inputNombreCompleto" required
                                       class="w-full bg-black/30 border border-gray-700 text-white p-3 rounded-lg focus:border-orange-500 transition"
                                       placeholder="Ingresa el nombre completo">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    Teléfono *
                                </label>
                                <input type="tel" id="inputTelefono" required
                                       class="w-full bg-black/30 border border-gray-700 text-white p-3 rounded-lg focus:border-orange-500 transition"
                                       placeholder="Número de teléfono">
                            </div>
                        </div>

                        <div class="mt-6">
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Correo Electrónico *
                            </label>
                            <input type="email" id="inputEmail" required
                                   class="w-full bg-black/30 border border-gray-700 text-white p-3 rounded-lg focus:border-orange-500 transition"
                                   placeholder="correo@ejemplo.com">
                            <p class="mt-1 text-xs text-gray-400">
                                Este email se usará para crear la cuenta de usuario del cliente
                            </p>
                        </div>
                    </div>

                    <!-- Sección 2: Información de Contacto -->
                    <div>
                        <h2 class="text-xl font-bold text-orange-400 mb-4 flex items-center gap-2">
                            <i class="bx bx-map"></i>
                            Información de Contacto
                        </h2>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Dirección Completa
                            </label>
                            <textarea id="textareaDireccion" rows="3"
                                      class="w-full bg-black/30 border border-gray-700 text-white p-3 rounded-lg focus:border-orange-500 transition resize-none"
                                      placeholder="Calle, número, colonia, ciudad, estado, código postal..."></textarea>
                        </div>
                    </div>

                    <!-- Sección 3: Información de Usuario -->
                    <div>
                        <h2 class="text-xl font-bold text-orange-400 mb-4 flex items-center gap-2">
                            <i class="bx bx-lock-alt"></i>
                            Información de Usuario
                        </h2>

                        <div class="bg-black/30 p-4 rounded-lg border border-gray-600 mb-4">
                            <p class="text-sm text-gray-300 mb-3">
                                Se creará automáticamente una cuenta de usuario para el cliente con rol "cliente":
                            </p>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">
                                        Nombre de Usuario *
                                    </label>
                                    <input type="text" id="inputUsername" required
                                           class="w-full bg-black/30 border border-gray-700 text-white p-3 rounded-lg focus:border-orange-500 transition"
                                           placeholder="Nombre de usuario para iniciar sesión">
                                    <p class="mt-1 text-xs text-gray-400">
                                        Se generará automáticamente del email
                                    </p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">
                                        Contraseña Temporal *
                                    </label>
                                    <div class="flex gap-2">
                                        <input type="text" id="inputPassword" required
                                               class="flex-1 bg-black/30 border border-gray-700 text-white p-3 rounded-lg focus:border-orange-500 transition"
                                               placeholder="Contraseña temporal" value="Cliente123">
                                        <button type="button" onclick="generarPassword()"
                                                class="bg-gray-700 hover:bg-gray-600 transition px-4 py-3 rounded-lg">
                                            <i class="bx bx-refresh"></i>
                                        </button>
                                    </div>
                                    <p class="mt-1 text-xs text-gray-400">
                                        El cliente podrá cambiar esta contraseña después
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección 4: Estado del Cliente -->
                    <div>
                        <h2 class="text-xl font-bold text-orange-400 mb-4 flex items-center gap-2">
                            <i class="bx bx-cog"></i>
                            Estado del Cliente
                        </h2>

                        <div class="flex items-center gap-3 p-4 bg-black/30 rounded-lg border border-gray-600">
                            <input type="checkbox" id="checkClienteActivo" checked
                                   class="w-4 h-4 accent-orange-500 bg-black/30 border-gray-700 rounded focus:ring-orange-500">
                            <div>
                                <label for="checkClienteActivo" class="text-sm font-medium text-gray-300 block">
                                    Cliente Activo
                                </label>
                                <p class="text-xs text-gray-400">
                                    Podrá acceder al sistema y recibir servicios
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen de Información -->
                    <div class="bg-black/30 p-4 rounded-lg border border-gray-600">
                        <h3 class="text-lg font-semibold text-orange-400 mb-3">Resumen del Cliente</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="text-gray-400">Nombre:</p>
                                <p id="resumenNombre" class="font-medium">-</p>
                            </div>
                            <div>
                                <p class="text-gray-400">Teléfono:</p>
                                <p id="resumenTelefono" class="font-medium">-</p>
                            </div>
                            <div>
                                <p class="text-gray-400">Email:</p>
                                <p id="resumenEmail" class="font-medium">-</p>
                            </div>
                            <div>
                                <p class="text-gray-400">Usuario:</p>
                                <p id="resumenUsuario" class="font-medium">-</p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-gray-400">Dirección:</p>
                                <p id="resumenDireccion" class="font-medium">-</p>
                            </div>
                            <div>
                                <p class="text-gray-400">Estado:</p>
                                <p id="resumenEstado" class="font-medium text-green-400">Activo</p>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="flex justify-end gap-4 pt-6 border-t border-gray-700">
                        <a href="/trabajador/clientes.html"
                           class="px-8 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-medium transition">
                            Cancelar
                        </a>
                        <button type="submit"
                                class="px-8 py-3 bg-orange-600 hover:bg-orange-500 rounded-lg font-medium transition flex items-center gap-2">
                            <i class="bx bx-save"></i>
                            Registrar Cliente
                        </button>
                    </div>
                </form>
            </div>

            <!-- Información Adicional -->
            <div class="mt-6 bg-[#1A1A1A] p-4 rounded-xl border border-gray-700">
                <h3 class="text-lg font-semibold text-orange-400 mb-3">Información Importante</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg">
                        <h4 class="font-medium text-blue-400 mb-1">Cuenta de Usuario</h4>
                        <p class="text-gray-400">Se crea automáticamente una cuenta con rol "cliente" que permite al cliente ver el estado de sus servicios.</p>
                    </div>
                    <div class="p-3 bg-green-500/10 border border-green-500/20 rounded-lg">
                        <h4 class="font-medium text-green-400 mb-1">Credenciales Temporales</h4>
                        <p class="text-gray-400">El cliente recibirá una contraseña temporal que podrá cambiar en su primer acceso al sistema.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<!-- Modal de Confirmación -->
<div id="modalConfirmacion" class="fixed inset-0 bg-black/70 backdrop-blur-md hidden justify-center items-center z-50">
    <div class="bg-[#1A1A1A]/95 p-8 rounded-2xl shadow-xl border border-orange-500/30 w-[500px] animate-[zoomIn_.3s_ease]">
        <div class="text-center">
            <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="bx bx-check text-green-400 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">¡Cliente Registrado!</h3>
            <p class="text-gray-400 mb-4">El cliente ha sido registrado exitosamente en el sistema.</p>

            <div class="bg-black/30 p-4 rounded-lg border border-gray-700 mb-6 text-left">
                <h4 class="font-semibold text-orange-400 mb-2">Credenciales de Acceso:</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Usuario:</span>
                        <span class="font-mono" id="confirmacionUsuario">usuario123</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Contraseña:</span>
                        <span class="font-mono" id="confirmacionPassword">Cliente123</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Email:</span>
                        <span id="confirmacionEmail">cliente@email.com</span>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 justify-center">
                <button onclick="cerrarModalConfirmacion()"
                        class="px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                    Registrar Otro Cliente
                </button>
                <a href="/trabajador/clientes.html"
                   class="px-6 py-2 bg-orange-600 hover:bg-orange-500 rounded-lg transition">
                    Ver Lista de Clientes
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Loader -->
<div id="loader" class="hidden fixed inset-0 bg-black/70 backdrop-blur-md flex justify-center items-center z-50">
    <div class="bg-[#1A1A1A] p-8 rounded-2xl shadow-xl border border-orange-500/30">
        <div class="flex flex-col items-center gap-4">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600"></div>
            <p class="text-gray-300">Guardando cliente...</p>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="hidden fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50">
    <p id="toastMessage"></p>
</div>

<style>
    @keyframes zoomIn {
        0% {
            opacity: 0;
            transform: scale(0.85);
        }
        100% {
            opacity: 1;
            transform: scale(1);
        }
    }

    input:focus, select:focus, textarea:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(255, 140, 0, 0.2);
    }
</style>

<script>
    const API_URL_CLIENTES = 'http://localhost:8080/api/clientes';
    const API_URL_USUARIOS = 'http://localhost:8080/api/usuarios';

    // Inicializar la página
    document.addEventListener('DOMContentLoaded', function() {
        verificarSesion();
        configurarEventos();
        actualizarResumen();
    });

    function verificarSesion() {
        const usuario = sessionStorage.getItem('usuario');
        if (!usuario) {
            window.location.href = '../login.html';
            return;
        }
        const userData = JSON.parse(usuario);
        document.getElementById('usuarioNombre').textContent = userData.nombreUsuario || 'Trabajador';
    }

    function cerrarSesion() {
        if (confirm('¿Está seguro de cerrar sesión?')) {
            sessionStorage.clear();
            localStorage.clear();
            window.location.href = '../login.html';
        }
    }

    // Configurar eventos
    function configurarEventos() {
        // Actualizar resumen en tiempo real
        document.getElementById('inputNombreCompleto').addEventListener('input', actualizarResumen);
        document.getElementById('inputTelefono').addEventListener('input', actualizarResumen);
        document.getElementById('inputEmail').addEventListener('input', actualizarResumen);
        document.getElementById('textareaDireccion').addEventListener('input', actualizarResumen);
        document.getElementById('inputUsername').addEventListener('input', actualizarResumen);
        document.getElementById('checkClienteActivo').addEventListener('change', actualizarResumen);

        // Generar username automáticamente desde el email
        document.getElementById('inputEmail').addEventListener('blur', function() {
            const email = this.value.trim();
            if (email && !document.getElementById('inputUsername').value) {
                const username = email.split('@')[0];
                document.getElementById('inputUsername').value = username;
                actualizarResumen();
            }
        });

        // Formulario de alta
        document.getElementById('formAltaCliente').addEventListener('submit', function(e) {
            e.preventDefault();
            registrarCliente();
        });
    }

    // Actualizar resumen en tiempo real
    function actualizarResumen() {
        document.getElementById('resumenNombre').textContent =
            document.getElementById('inputNombreCompleto').value || '-';

        document.getElementById('resumenTelefono').textContent =
            document.getElementById('inputTelefono').value || '-';

        document.getElementById('resumenEmail').textContent =
            document.getElementById('inputEmail').value || '-';

        document.getElementById('resumenUsuario').textContent =
            document.getElementById('inputUsername').value || '-';

        document.getElementById('resumenDireccion').textContent =
            document.getElementById('textareaDireccion').value || 'No especificada';

        const activo = document.getElementById('checkClienteActivo').checked;
        document.getElementById('resumenEstado').textContent = activo ? 'Activo' : 'Inactivo';
        document.getElementById('resumenEstado').className = activo ?
            'font-medium text-green-400' : 'font-medium text-red-400';
    }

    // Generar contraseña aleatoria
    function generarPassword() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let password = 'Cliente';

        // Agregar 3 números aleatorios
        for (let i = 0; i < 3; i++) {
            password += Math.floor(Math.random() * 10);
        }

        document.getElementById('inputPassword').value = password;
    }

    // Validar formulario
    function validarFormulario() {
        const nombre = document.getElementById('inputNombreCompleto').value.trim();
        const telefono = document.getElementById('inputTelefono').value.trim();
        const email = document.getElementById('inputEmail').value.trim();
        const username = document.getElementById('inputUsername').value.trim();
        const password = document.getElementById('inputPassword').value.trim();

        if (!nombre) {
            mostrarToast('Por favor ingresa el nombre completo del cliente', 'error');
            return false;
        }

        if (!telefono) {
            mostrarToast('Por favor ingresa el número de teléfono', 'error');
            return false;
        }

        if (!email) {
            mostrarToast('Por favor ingresa el correo electrónico', 'error');
            return false;
        }

        // Validar formato de email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            mostrarToast('Por favor ingresa un correo electrónico válido', 'error');
            return false;
        }

        if (!username) {
            mostrarToast('Por favor ingresa un nombre de usuario', 'error');
            return false;
        }

        if (!password) {
            mostrarToast('Por favor ingresa una contraseña temporal', 'error');
            return false;
        }

        if (password.length < 6) {
            mostrarToast('La contraseña debe tener al menos 6 caracteres', 'error');
            return false;
        }

        return true;
    }

    // Registrar cliente
    async function registrarCliente() {
        if (!validarFormulario()) {
            return;
        }

        const nombreCompleto = document.getElementById('inputNombreCompleto').value.trim();
        const telefono = document.getElementById('inputTelefono').value.trim();
        const email = document.getElementById('inputEmail').value.trim();
        const direccion = document.getElementById('textareaDireccion').value.trim();
        const username = document.getElementById('inputUsername').value.trim();
        const password = document.getElementById('inputPassword').value.trim();
        const activo = document.getElementById('checkClienteActivo').checked;

        try {
            mostrarCargando(true);

            // 1. Crear Usuario primero
            console.log('Creando usuario...');
            const usuarioData = {
                username: username,
                password: password,
                nombreCompleto: nombreCompleto,
                email: email,
                rol: 'cliente',
                activo: activo
            };

            const responseUsuario = await fetch(API_URL_USUARIOS, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(usuarioData)
            });

            if (!responseUsuario.ok) {
                const errorData = await responseUsuario.json();
                throw new Error(errorData.error || 'Error al crear el usuario');
            }

            const usuarioGuardado = await responseUsuario.json();
            console.log('Usuario creado:', usuarioGuardado);

            // 2. Crear Cliente vinculado al usuario
            console.log('Creando cliente...');
            const clienteData = {
                nombreCompleto: nombreCompleto,
                telefono: telefono,
                email: email,
                direccion: direccion || null,
                activo: activo,
                usuario: {
                    idUsuario: usuarioGuardado.idUsuario
                }
            };

            const responseCliente = await fetch(API_URL_CLIENTES, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(clienteData)
            });

            if (!responseCliente.ok) {
                throw new Error('Usuario creado pero error al crear el cliente');
            }

            const clienteGuardado = await responseCliente.json();
            console.log('Cliente creado:', clienteGuardado);

            // Mostrar modal de confirmación
            mostrarModalConfirmacion({
                username: username,
                password: password,
                email: email
            });

            mostrarToast('Cliente y usuario creados correctamente', 'success');

        } catch (error) {
            console.error('Error:', error);
            mostrarToast(error.message, 'error');
        } finally {
            mostrarCargando(false);
        }
    }

    // Mostrar modal de confirmación
    function mostrarModalConfirmacion(data) {
        document.getElementById('confirmacionUsuario').textContent = data.username;
        document.getElementById('confirmacionPassword').textContent = data.password;
        document.getElementById('confirmacionEmail').textContent = data.email;

        document.getElementById('modalConfirmacion').classList.remove('hidden');
        document.getElementById('modalConfirmacion').classList.add('flex');
    }

    // Cerrar modal de confirmación
    function cerrarModalConfirmacion() {
        document.getElementById('modalConfirmacion').classList.add('hidden');
        document.getElementById('modalConfirmacion').classList.remove('flex');

        // Limpiar formulario
        document.getElementById('formAltaCliente').reset();
        document.getElementById('inputPassword').value = 'Cliente123';
        actualizarResumen();
    }

    function mostrarCargando(mostrar) {
        document.getElementById('loader').classList.toggle('hidden', !mostrar);
    }

    function mostrarToast(mensaje, tipo = 'info') {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const colores = {
            success: 'bg-green-500',
            error: 'bg-red-500',
            info: 'bg-blue-500'
        };
        toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${colores[tipo]}`;
        toastMessage.textContent = mensaje;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    // Cerrar modal con ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            cerrarModalConfirmacion();
        }
    });
</script>
</body>

</html>