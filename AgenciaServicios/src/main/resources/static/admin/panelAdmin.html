<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title>Panel Administrador - Siscare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/logout.js"></script>
</head>

<body class="bg-[#0D0D0D] text-white min-h-screen flex">
    <!-- SIDEBAR -->
    <aside class="w-64 bg-black/80 border-r border-orange-600/20 flex flex-col justify-between py-6 px-4">
        <div>
            <h2 class="text-3xl font-bold text-orange-500 border-b border-gray-700 pb-2 mb-6 text-center">
                Siscare
            </h2>

            <nav class="flex flex-col gap-1">
                <a href="/admin/panelAdmin.html"
                    class="flex items-center gap-3 p-3 rounded bg-orange-500/20 transition">
                    <i class="bx bx-home text-xl"></i> Panel
                </a>

                <a href="/admin/servicios.html"
                    class="flex items-center gap-3 p-3 rounded hover:bg-orange-500/20 transition">
                    <i class="bx bx-wrench text-xl"></i> Servicios
                </a>

                <a href="/admin/usuarios.html"
                    class="flex items-center gap-3 p-3 rounded hover:bg-orange-500/20 transition">
                    <i class="bx bx-id-card text-xl"></i> Usuarios
                </a>

                <!-- Secci√≥n de Cat√°logos -->
                <div>
                    <button id="btnCatalogos"
                        class="flex justify-between items-center w-full p-3 hover:bg-orange-500/20 rounded transition">
                        <span class="flex items-center gap-3"><i class="bx bx-folder text-xl"></i> Cat√°logos</span>
                        <i id="iconArrow" class="bx bx-chevron-down text-xl"></i>
                    </button>

                    <div id="submenuCatalogos" class="pl-10 mt-1 flex flex-col hidden">
                        <a href="/admin/catalogoTiposServicio.html"
                            class="block py-2 text-sm hover:text-orange-400">Tipos de Servicio</a>
                        <a href="/admin/catalogoRefacciones.html"
                            class="block py-2 text-sm hover:text-orange-400">Refacciones</a>
                        <a href="/admin/catalogoMarcas.html" class="block py-2 text-sm hover:text-orange-400">Marcas</a>
                        <a href="/admin/catalogoModelos.html"
                            class="block py-2 text-sm hover:text-orange-400">Modelos</a>
                    </div>
                </div>
            </nav>
        </div>

        <div class="border-t border-gray-700 pt-4">
            <a href="/login.html"
                class="flex items-center gap-3 p-3 hover:bg-red-500/30 rounded transition text-red-400">
                <i class="bx bx-log-out text-xl"></i> Cerrar Sesi√≥n
            </a>
        </div>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="flex-1 flex flex-col">
        <!-- NAVBAR SUPERIOR -->
        <header
            class="flex justify-between items-center px-8 py-4 border-b border-gray-800 bg-[#111]/80 backdrop-blur-sm">
            <div>
                <h1 class="text-2xl font-bold">Dashboard Administrativo</h1>
                <p class="text-gray-400 text-sm">Resumen general del sistema</p>
            </div>

            <!-- Icono de usuario y bot√≥n crear servicio -->
            <div class="flex items-center gap-4">
                <a href="/admin/crearServicio.html"
                    class="flex items-center gap-2 bg-orange-600 hover:bg-orange-500 transition px-4 py-2 rounded shadow">
                    <i class="bx bx-plus"></i> Crear Servicio
                </a>
                <div class="flex items-center gap-3">
                    <span class="text-gray-300 text-sm">Administrador</span>
                    <button class="bg-orange-600 hover:bg-orange-500 p-2 rounded-full transition">
                        <i class="bx bx-user text-white text-xl"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- CONTENIDO -->
        <section class="p-8 flex-1 overflow-y-auto">
            <!-- Estad√≠sticas Principales -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Servicios -->
                <div class="bg-[#1A1A1A] p-6 rounded-xl border border-gray-700 hover:border-orange-500/50 transition">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-400 text-sm">Total Servicios</p>
                            <p id="totalServicios" class="text-3xl font-bold">-</p>
                            <p class="text-gray-400 text-sm mt-1">Todos los tiempos</p>
                        </div>
                        <div class="bg-blue-500/20 p-4 rounded-full">
                            <i class="bx bx-wrench text-blue-400 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Servicios Activos -->
                <div class="bg-[#1A1A1A] p-6 rounded-xl border border-gray-700 hover:border-orange-500/50 transition">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-400 text-sm">Servicios Activos</p>
                            <p id="serviciosActivos" class="text-3xl font-bold text-yellow-400">-</p>
                            <p class="text-gray-400 text-sm mt-1">En proceso y pendientes</p>
                        </div>
                        <div class="bg-yellow-500/20 p-4 rounded-full">
                            <i class="bx bx-time text-yellow-400 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Ingresos del Mes -->
                <div class="bg-[#1A1A1A] p-6 rounded-xl border border-gray-700 hover:border-orange-500/50 transition">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-400 text-sm">Ingresos del Mes</p>
                            <p id="ingresosMes" class="text-3xl font-bold text-green-400">-</p>
                            <p class="text-gray-400 text-sm mt-1">Mes actual</p>
                        </div>
                        <div class="bg-green-500/20 p-4 rounded-full">
                            <i class="bx bx-dollar text-green-400 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Clientes Activos -->
                <div class="bg-[#1A1A1A] p-6 rounded-xl border border-gray-700 hover:border-orange-500/50 transition">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-400 text-sm">Clientes Activos</p>
                            <p id="clientesActivos" class="text-3xl font-bold">-</p>

                        </div>
                        <div class="bg-purple-500/20 p-4 rounded-full">
                            <i class="bx bx-user text-purple-400 text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°ficas y M√©tricas -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Gr√°fica de Estatus de Servicios -->
                <div class="bg-[#1A1A1A] p-6 rounded-xl border border-gray-700">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-orange-400">Estatus de Servicios</h2>
                        <div class="flex gap-2">
                            <select id="selectPeriodoGrafica"
                                class="bg-black/30 border border-gray-700 text-white p-2 rounded text-sm">
                                <option value="mes" selected>Este Mes</option>
                                <option value="semana">Esta Semana</option>
                                <option value="total">Total General</option>
                            </select>
                        </div>
                    </div>
                    <div class="h-80">
                        <canvas id="graficaEstatusServicios"></canvas>
                    </div>
                </div>

                <!-- Servicios Recientes -->
                <div class="bg-[#1A1A1A] p-6 rounded-xl border border-gray-700">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-orange-400">Servicios Recientes</h2>
                        <a href="/admin/servicios.html" class="text-orange-400 hover:text-orange-300 text-sm">
                            Ver todos <i class="bx bx-chevron-right"></i>
                        </a>
                    </div>
                    <div id="listaServiciosRecientes" class="space-y-4">
                        <div class="text-center py-8 text-gray-400">
                            <i class="bx bx-loader-circle bx-spin text-2xl mb-2"></i>
                            <p>Cargando servicios recientes...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n Adicional -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Refacciones con Bajo Stock -->
                <div class="bg-[#1A1A1A] p-6 rounded-xl border border-gray-700">
                    <h2 class="text-xl font-bold text-orange-400 mb-6">Refacciones con Bajo Stock</h2>
                    <div id="listaRefaccionesBajoStock" class="space-y-3">
                        <div class="text-center py-8 text-gray-400">
                            <i class="bx bx-loader-circle bx-spin text-2xl mb-2"></i>
                            <p>Cargando refacciones...</p>
                        </div>
                    </div>
                </div>

                <!-- Veh√≠culos por Marca -->
                <div class="bg-[#1A1A1A] p-6 rounded-xl border border-gray-700">
                    <h2 class="text-xl font-bold text-orange-400 mb-6">Veh√≠culos por Marca</h2>
                    <div id="listaVehiculosPorMarca" class="space-y-3">
                        <div class="text-center py-8 text-gray-400">
                            <i class="bx bx-loader-circle bx-spin text-2xl mb-2"></i>
                            <p>Cargando veh√≠culos...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 140, 0, 0.1);
        }
    </style>

    <script>
    // URLs de tus APIs existentes
    const API_URLS = {
        servicios: "/api/servicios",
        clientes: "/api/clientes",
        vehiculos: "/api/vehiculos",
        refacciones: "/api/refacciones",
        marcas: "/api/marcas"
    };

    // Variables globales para almacenar datos
    let datosCargados = {
        servicios: [],
        clientes: [],
        vehiculos: [],
        refacciones: [],
        marcas: []
    };

    // Cache para datos
    let cache = {
        servicios: null,
        timestamp: null
    };

    // Inicializar la p√°gina
    document.addEventListener('DOMContentLoaded', function () {
        configurarEventos();
        cargarDashboardOptimizado();
    });

    // Configurar eventos
    function configurarEventos() {
        // Submen√∫ de Cat√°logos
        const btnCatalogos = document.getElementById("btnCatalogos");
        const submenu = document.getElementById("submenuCatalogos");
        const iconArrow = document.getElementById("iconArrow");

        if (btnCatalogos) {
            btnCatalogos.addEventListener("click", () => {
                submenu.classList.toggle("hidden");
                iconArrow.classList.toggle("bx-chevron-down");
                iconArrow.classList.toggle("bx-chevron-up");
            });
        }

        // Cambio en per√≠odo de gr√°fica - MEJORADO
        const selectPeriodo = document.getElementById('selectPeriodoGrafica');
        if (selectPeriodo) {
            selectPeriodo.addEventListener('change', function () {
                console.log(`üîÑ Cambiando per√≠odo a: ${this.value}`);
                cargarGraficaEstatusServicios();
                actualizarTituloGrafica(this.value);
            });
        }

        // Agregar efecto hover a las cards
        //const cards = document.querySelectorAll('.bg-\\[#1A1A1A\\]');
        //cards.forEach(card => {
          //  card.classList.add('card-hover');
        //});
    }

    // ==================== FUNCI√ìN PRINCIPAL OPTIMIZADA ====================

    async function cargarDashboardOptimizado() {
        try {
            console.log("üöÄ Iniciando carga optimizada del dashboard...");
            mostrarLoading(true);

            // ESTRATEGIA: Cargar servicios primero (lo m√°s importante) y mostrar inmediatamente
            await cargarServiciosRapido();
            
            // Mostrar datos cr√≠ticos inmediatamente
            await cargarEstadisticasPrincipales();
            await cargarGraficaEstatusServicios();
            await cargarServiciosRecientes();

            // Cargar el resto en segundo plano (menos cr√≠tico) despu√©s de un breve delay
            setTimeout(() => {
                cargarDatosSecundarios();
            }, 1000);

        } catch (error) {
            console.error('‚ùå Error en carga principal:', error);
            mostrarError('Error al cargar datos principales');
        } finally {
            // No ocultar loading completo aqu√≠, solo cuando terminen los secundarios
        }
    }

    // Cargar datos secundarios (menos importantes) en segundo plano
    async function cargarDatosSecundarios() {
        try {
            console.log("üîÑ Cargando datos secundarios en segundo plano...");
            
            await Promise.all([
                cargarClientes(),
                cargarVehiculos(),
                cargarRefacciones(),
                cargarMarcas()
            ]);
            
            // Actualizar secciones que dependen de estos datos
            await actualizarClientesActivos();
            await cargarRefaccionesBajoStock();
            await cargarVehiculosPorMarca();
            
            console.log("‚úÖ Todos los datos secundarios cargados");
            
        } catch (error) {
            console.error('‚ö†Ô∏è Error en datos secundarios:', error);
            // No mostramos error al usuario para no molestar
        } finally {
            mostrarLoading(false);
        }
    }

    // ==================== FUNCIONES DE CARGA OPTIMIZADAS ====================

    async function cargarServiciosRapido() {
        try {
            // Verificar cache (v√°lido por 30 segundos)
            const ahora = Date.now();
            if (cache.servicios && cache.timestamp && (ahora - cache.timestamp < 30000)) {
                datosCargados.servicios = cache.servicios;
                console.log("üìä Servicios cargados desde cache");
                return;
            }

            console.log("üì• Solicitando servicios desde API...");
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // Timeout de 10 segundos

            const response = await fetch(API_URLS.servicios, {
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            datosCargados.servicios = await response.json();
            
            // Guardar en cache
            cache.servicios = datosCargados.servicios;
            cache.timestamp = ahora;
            
            console.log(`üìä ${datosCargados.servicios.length} servicios cargados`);
        } catch (error) {
            if (error.name === 'AbortError') {
                console.error("‚è∞ Timeout cargando servicios");
                mostrarError('Timeout al cargar servicios');
            } else {
                console.error("‚ùå Error cargando servicios:", error);
                mostrarError('Error al cargar servicios');
            }
            datosCargados.servicios = [];
        }
    }

    async function cargarClientes() {
        try {
            const response = await fetch(API_URLS.clientes);
            if (!response.ok) return; // No lanzar error, es secundario
            datosCargados.clientes = await response.json();
            console.log(`üë• ${datosCargados.clientes.length} clientes cargados`);
        } catch (error) {
            console.error("‚ö†Ô∏è Error cargando clientes:", error);
            datosCargados.clientes = [];
        }
    }

    async function cargarVehiculos() {
        try {
            const response = await fetch(API_URLS.vehiculos);
            if (!response.ok) return;
            datosCargados.vehiculos = await response.json();
            console.log(`üöó ${datosCargados.vehiculos.length} veh√≠culos cargados`);
        } catch (error) {
            console.error("‚ö†Ô∏è Error cargando veh√≠culos:", error);
            datosCargados.vehiculos = [];
        }
    }

    async function cargarRefacciones() {
        try {
            const response = await fetch(API_URLS.refacciones);
            if (!response.ok) return;
            datosCargados.refacciones = await response.json();
            console.log(`üîß ${datosCargados.refacciones.length} refacciones cargadas`);
        } catch (error) {
            console.error("‚ö†Ô∏è Error cargando refacciones:", error);
            datosCargados.refacciones = [];
        }
    }

    async function cargarMarcas() {
        try {
            const response = await fetch(API_URLS.marcas);
            if (!response.ok) return;
            datosCargados.marcas = await response.json();
            console.log(`üè∑Ô∏è ${datosCargados.marcas.length} marcas cargadas`);
        } catch (error) {
            console.error("‚ö†Ô∏è Error cargando marcas:", error);
            datosCargados.marcas = [];
        }
    }

    // ==================== FUNCIONES DE VISUALIZACI√ìN OPTIMIZADAS ====================

    // 1. Cargar estad√≠sticas principales (OPTIMIZADO)
    async function cargarEstadisticasPrincipales() {
        try {
            const servicios = datosCargados.servicios;
            
            // C√°lculos optimizados - una sola pasada por los servicios
            let serviciosActivos = 0;
            let ingresosMes = 0;
            const hoy = new Date();
            const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);

            // Usar for loop que es m√°s r√°pido para arrays grandes
            for (let i = 0; i < servicios.length; i++) {
                const servicio = servicios[i];
                
                // Contar servicios activos
                if (servicio.estatus === 'PENDIENTE' || servicio.estatus === 'EN_PROCESO') {
                    serviciosActivos++;
                }
                
                // Calcular ingresos del mes
                if (servicio.fechaEntregaReal) {
                    const fechaEntrega = new Date(servicio.fechaEntregaReal);
                    if (fechaEntrega >= primerDiaMes && fechaEntrega <= hoy) {
                        ingresosMes += servicio.costoTotal || 0;
                    }
                }
            }

            // Actualizar UI inmediatamente
            actualizarElementoSeguro('totalServicios', servicios.length);
            actualizarElementoSeguro('serviciosActivos', serviciosActivos);
            actualizarElementoSeguro('ingresosMes', '$' + ingresosMes.toLocaleString('es-MX', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }));
            
            // Clientes se actualizar√° despu√©s cuando se carguen
            actualizarElementoSeguro('clientesActivos', '...');
            
            console.log("‚úÖ Estad√≠sticas principales actualizadas");
            
        } catch (error) {
            console.error('‚ùå Error cargando estad√≠sticas:', error);
            // Establecer valores de error
            actualizarElementoSeguro('totalServicios', 'Error');
            actualizarElementoSeguro('serviciosActivos', 'Error');
            actualizarElementoSeguro('ingresosMes', 'Error');
            actualizarElementoSeguro('clientesActivos', 'Error');
        }
    }

    // 2. Cargar gr√°fica de estatus de servicios CON FILTRO POR PER√çODO
    async function cargarGraficaEstatusServicios() {
        try {
            const servicios = datosCargados.servicios;
            const periodo = document.getElementById('selectPeriodoGrafica')?.value || 'mes';
            
            // Filtrar servicios por per√≠odo
            const serviciosFiltrados = filtrarServiciosPorPeriodo(servicios, periodo);
            
            console.log(`üìà Filtrando por per√≠odo: ${periodo}, ${serviciosFiltrados.length} servicios`);

            // Contar servicios por estatus
            const conteoEstatus = serviciosFiltrados.reduce((acc, servicio) => {
                const estatus = servicio.estatus || 'DESCONOCIDO';
                acc[estatus] = (acc[estatus] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(conteoEstatus);
            const values = Object.values(conteoEstatus);

            console.log("üìà Datos para gr√°fica:", { labels, values });

            // Actualizar gr√°fica existente en lugar de recrearla
            if (window.graficaEstatus) {
                window.graficaEstatus.data.labels = labels;
                window.graficaEstatus.data.datasets[0].data = values;
                window.graficaEstatus.update('none'); // 'none' para animaci√≥n m√°s r√°pida
                console.log("‚úÖ Gr√°fica actualizada (existente)");
            } else {
                // Crear gr√°fica por primera vez
                const ctx = document.getElementById('graficaEstatusServicios').getContext('2d');
                window.graficaEstatus = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: [
                                '#10B981', // Completado/Entregado
                                '#F59E0B', // En Proceso
                                '#3B82F6', // Pendiente
                                '#EF4444', // Cancelado
                                '#8B5CF6', // Otros estados
                                '#06B6D4'  // M√°s estados
                            ],
                            borderWidth: 2,
                            borderColor: '#0D0D0D'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#9CA3AF',
                                    font: { size: 12 },
                                    padding: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: '#1F2937',
                                titleColor: '#F9FAFB',
                                bodyColor: '#D1D5DB',
                                borderColor: '#374151',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        cutout: '60%',
                        animation: {
                            duration: 800 // Animaci√≥n m√°s r√°pida
                        }
                    }
                });
                console.log("‚úÖ Gr√°fica creada por primera vez");
            }
            
        } catch (error) {
            console.error('‚ùå Error cargando gr√°fica de estatus:', error);
            const container = document.getElementById('graficaEstatusServicios');
            if (container) {
                container.innerHTML = 
                    '<div class="text-center text-gray-400 py-8">Error al cargar la gr√°fica</div>';
            }
        }
    }

    // Funci√≥n para filtrar servicios por per√≠odo
    function filtrarServiciosPorPeriodo(servicios, periodo) {
        const hoy = new Date();
        
        switch (periodo) {
            case 'dia':
                // Servicios del d√≠a actual (por fecha de ingreso)
                const inicioDia = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
                const finDia = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate(), 23, 59, 59);
                
                return servicios.filter(servicio => {
                    if (!servicio.fechaIngreso) return false;
                    const fechaIngreso = new Date(servicio.fechaIngreso);
                    return fechaIngreso >= inicioDia && fechaIngreso <= finDia;
                });

            case 'semana':
                // Servicios de la semana actual (lunes a domingo)
                const inicioSemana = new Date(hoy);
                inicioSemana.setDate(hoy.getDate() - hoy.getDay() + (hoy.getDay() === 0 ? -6 : 1)); // Lunes
                inicioSemana.setHours(0, 0, 0, 0);
                
                const finSemana = new Date(inicioSemana);
                finSemana.setDate(inicioSemana.getDate() + 6); // Domingo
                finSemana.setHours(23, 59, 59, 999);
                
                return servicios.filter(servicio => {
                    if (!servicio.fechaIngreso) return false;
                    const fechaIngreso = new Date(servicio.fechaIngreso);
                    return fechaIngreso >= inicioSemana && fechaIngreso <= finSemana;
                });

            case 'mes':
                // Servicios del mes actual
                const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                const finMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0, 23, 59, 59);
                
                return servicios.filter(servicio => {
                    if (!servicio.fechaIngreso) return false;
                    const fechaIngreso = new Date(servicio.fechaIngreso);
                    return fechaIngreso >= inicioMes && fechaIngreso <= finMes;
                });

            case 'total':
            default:
                // Todos los servicios
                return servicios;
        }
    }

    // Funci√≥n para actualizar el t√≠tulo de la gr√°fica seg√∫n el per√≠odo
    function actualizarTituloGrafica(periodo) {
        const titulo = document.querySelector('#graficaEstatusServicios').closest('.bg-\\[#1A1A1A\\]').querySelector('h2');
        if (titulo) {
            const textos = {
                'dia': 'Estatus de Servicios - Hoy',
                'semana': 'Estatus de Servicios - Esta Semana',
                'mes': 'Estatus de Servicios - Este Mes',
                'total': 'Estatus de Servicios - Total General'
            };
            titulo.textContent = textos[periodo] || 'Estatus de Servicios';
        }
    }

    // 3. Cargar servicios recientes (OPTIMIZADO)
    async function cargarServiciosRecientes() {
        try {
            const servicios = datosCargados.servicios;
            
            // Ordenar y tomar solo los primeros 5 (m√°s eficiente que slice despu√©s de sort completo)
            const serviciosRecientes = servicios
                .sort((a, b) => new Date(b.fechaIngreso) - new Date(a.fechaIngreso))
                .slice(0, 5);

            const container = document.getElementById('listaServiciosRecientes');
            
            if (!container) {
                console.log("‚ö†Ô∏è No se encontr√≥ contenedor de servicios recientes");
                return;
            }

            if (serviciosRecientes.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">No hay servicios recientes</div>';
                return;
            }
            
            // Construir HTML de forma eficiente
            let html = '';
            for (let i = 0; i < serviciosRecientes.length; i++) {
                const servicio = serviciosRecientes[i];
                const vehiculoInfo = servicio.vehiculo ? 
                    `${servicio.vehiculo.modelo?.marca?.nombreMarca || 'Marca'} ${servicio.vehiculo.modelo?.nombreModelo || 'Modelo'}` : 
                    'Veh√≠culo no asignado';
                
                const clienteInfo = servicio.vehiculo?.cliente?.nombreCompleto || 'Cliente no asignado';
                
                html += `
                    <div class="flex justify-between items-center p-3 bg-black/30 rounded-lg border border-gray-700">
                        <div>
                            <p class="font-medium">SER-${String(servicio.folioServicio).padStart(6, '0')}</p>
                            <p class="text-gray-400 text-sm">${vehiculoInfo} - ${clienteInfo}</p>
                        </div>
                        <div class="text-right">
                            <span class="${obtenerClaseEstatus(servicio.estatus)} px-2 py-1 rounded-full text-xs">
                                ${obtenerTextoEstatus(servicio.estatus)}
                            </span>
                            <p class="text-gray-400 text-sm mt-1">${formatearFecha(servicio.fechaIngreso)}</p>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            console.log(`‚úÖ ${serviciosRecientes.length} servicios recientes mostrados`);
            
        } catch (error) {
            console.error('‚ùå Error cargando servicios recientes:', error);
            const container = document.getElementById('listaServiciosRecientes');
            if (container) {
                container.innerHTML = 
                    '<div class="text-center text-red-400 py-8">Error al cargar servicios</div>';
            }
        }
    }

    // 4. Cargar refacciones con bajo stock
    async function cargarRefaccionesBajoStock() {
        try {
            const refacciones = datosCargados.refacciones;
            
            // Filtrar refacciones con stock bajo (menos de 5 unidades)
            const refaccionesBajoStock = refacciones.filter(r => r.stock < 5);
            
            const container = document.getElementById('listaRefaccionesBajoStock');
            
            if (!container) {
                console.log("‚ö†Ô∏è No se encontr√≥ contenedor de refacciones");
                return;
            }

            if (refaccionesBajoStock.length === 0) {
                container.innerHTML = '<div class="text-center text-green-400 py-8">‚úÖ Todo el stock en niveles √≥ptimos</div>';
                return;
            }
            
            let html = '';
            for (let i = 0; i < refaccionesBajoStock.length; i++) {
                const refaccion = refaccionesBajoStock[i];
                html += `
                    <div class="flex justify-between items-center p-3 bg-red-500/10 border border-red-500/20 rounded-lg">
                        <div>
                            <p class="font-medium text-red-400">${refaccion.nombreRefaccion || 'Sin nombre'}</p>
                            <p class="text-gray-400 text-sm">Stock actual: ${refaccion.stock || 0} unidades</p>
                        </div>
                        <div class="text-right">
                            <span class="bg-red-500/20 text-red-400 px-2 py-1 rounded text-sm">¬°Stock Bajo!</span>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            console.log(`‚úÖ ${refaccionesBajoStock.length} refacciones con bajo stock mostradas`);
            
        } catch (error) {
            console.error('‚ùå Error cargando refacciones con bajo stock:', error);
            const container = document.getElementById('listaRefaccionesBajoStock');
            if (container) {
                container.innerHTML = 
                    '<div class="text-center text-red-400 py-8">Error al cargar refacciones</div>';
            }
        }
    }

    // 5. Cargar veh√≠culos por marca
    async function cargarVehiculosPorMarca() {
        try {
            const vehiculos = datosCargados.vehiculos;
            const marcas = datosCargados.marcas;
            
            // Contar veh√≠culos por marca
            const conteoPorMarca = {};
            
            for (let i = 0; i < vehiculos.length; i++) {
                const vehiculo = vehiculos[i];
                const marcaId = vehiculo.modelo?.marca?.idMarca;
                const marcaNombre = vehiculo.modelo?.marca?.nombreMarca || 'Sin marca';
                
                if (marcaId) {
                    if (!conteoPorMarca[marcaId]) {
                        conteoPorMarca[marcaId] = {
                            nombre_marca: marcaNombre,
                            total_vehiculos: 0
                        };
                    }
                    conteoPorMarca[marcaId].total_vehiculos++;
                }
            }

            const marcasConteo = Object.values(conteoPorMarca);
            const container = document.getElementById('listaVehiculosPorMarca');
            
            if (!container) {
                console.log("‚ö†Ô∏è No se encontr√≥ contenedor de veh√≠culos por marca");
                return;
            }

            if (marcasConteo.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">No hay veh√≠culos registrados</div>';
                return;
            }
            
            let html = '';
            for (let i = 0; i < marcasConteo.length; i++) {
                const marca = marcasConteo[i];
                html += `
                    <div class="flex justify-between items-center p-3 bg-black/30 rounded-lg border border-gray-700">
                        <span class="text-gray-300">${marca.nombre_marca}</span>
                        <span class="text-orange-400 font-medium">${marca.total_vehiculos} veh√≠culos</span>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            console.log(`‚úÖ ${marcasConteo.length} marcas con veh√≠culos mostradas`);
            
        } catch (error) {
            console.error('‚ùå Error cargando veh√≠culos por marca:', error);
            const container = document.getElementById('listaVehiculosPorMarca');
            if (container) {
                container.innerHTML = 
                    '<div class="text-center text-red-400 py-8">Error al cargar veh√≠culos</div>';
            }
        }
    }

    // 6. Actualizar clientes activos (funci√≥n separada para llamada desde secundarios)
    async function actualizarClientesActivos() {
        try {
            const clientesActivos = datosCargados.clientes.length;
            actualizarElementoSeguro('clientesActivos', clientesActivos);
            console.log(`‚úÖ Clientes activos actualizados: ${clientesActivos}`);
        } catch (error) {
            console.error('‚ùå Error actualizando clientes activos:', error);
            actualizarElementoSeguro('clientesActivos', 'Error');
        }
    }

    // ==================== FUNCIONES AUXILIARES OPTIMIZADAS ====================

    // Funci√≥n segura para actualizar elementos
    function actualizarElementoSeguro(id, valor) {
        try {
            const elemento = document.getElementById(id);
            if (elemento) {
                elemento.textContent = valor;
            }
        } catch (error) {
            console.error(`‚ö†Ô∏è Error actualizando elemento ${id}:`, error);
        }
    }

    function calcularIngresosDelMes(servicios) {
        const hoy = new Date();
        const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);

        return servicios
            .filter(servicio => {
                if (!servicio.fechaEntregaReal) return false;
                const fechaEntrega = new Date(servicio.fechaEntregaReal);
                return fechaEntrega >= primerDiaMes && fechaEntrega <= hoy;
            })
            .reduce((total, servicio) => total + (servicio.costoTotal || 0), 0);
    }

    function obtenerClaseEstatus(estatus) {
        if (!estatus) return 'bg-gray-500/20 text-gray-400';

        const clases = {
            'ENTREGADO': 'bg-green-500/20 text-green-400',
            'EN_PROCESO': 'bg-yellow-500/20 text-yellow-400',
            'PENDIENTE': 'bg-blue-500/20 text-blue-400',
            'COMPLETADO': 'bg-green-500/20 text-green-400',
            'CANCELADO': 'bg-red-500/20 text-red-400'
        };
        return clases[estatus] || 'bg-gray-500/20 text-gray-400';
    }

    function obtenerTextoEstatus(estatus) {
        if (!estatus) return 'Desconocido';

        const textos = {
            'ENTREGADO': 'Entregado',
            'EN_PROCESO': 'En Proceso',
            'PENDIENTE': 'Pendiente',
            'COMPLETADO': 'Completado',
            'CANCELADO': 'Cancelado'
        };
        return textos[estatus] || estatus;
    }

    function formatearFecha(fechaString) {
        if (!fechaString) return 'Fecha no disponible';

        try {
            const fecha = new Date(fechaString);
            return fecha.toLocaleDateString('es-MX', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        } catch (error) {
            return 'Fecha inv√°lida';
        }
    }

    function mostrarLoading(mostrar) {
        try {
            if (mostrar) {
                console.log("‚è≥ Mostrando loading...");
                // Puedes agregar aqu√≠ un spinner visual si lo deseas
            } else {
                console.log("‚úÖ Ocultando loading");
                // Ocultar spinner visual si lo agregaste
            }
        } catch (error) {
            console.error("‚ö†Ô∏è Error en mostrarLoading:", error);
        }
    }

    function mostrarError(mensaje) {
        try {
            console.error('‚ùå Error:', mensaje);
            
            // Sistema de notificaciones simple
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-lg z-50';
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="bx bx-error"></i>
                    <span>${mensaje}</span>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                try {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                } catch (e) {
                    console.error("Error removiendo notificaci√≥n:", e);
                }
            }, 5000);
            
        } catch (error) {
            console.error("‚ùå Error en mostrarError:", error);
        }
    }

    // Recargar datos cada 2 minutos (pero m√°s inteligente)
    setInterval(() => {
        console.log("üîÑ Recargando datos autom√°ticamente...");
        cargarDashboardOptimizado();
    }, 120000);

    // Exportar funciones para debugging si es necesario
    window.debugDashboard = {
        datos: datosCargados,
        recargar: cargarDashboardOptimizado,
        cache: cache
    };

</script>

</body>

</html>